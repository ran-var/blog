<section id="about" class="p-note">
  <p>
    Hey! I'm Ran, I do security for work and kitesurf for sanity. <br>
    I like to write whatever comes to my mind on here.
  </p>

  <% if (theme.social_links && theme.social_links.length) { %>
    <p>
      Find me on
      <% var nb_links = theme.social_links.length %>
      <% var i = 0 %>
      <% for(var {label, icon, link} of theme.social_links) { %>
        <% var title = label || icon %>
        <% if (icon == 'mail') { %>
          <a class="icon u-email" target="_blank" rel="noopener" href="<%- link %>" aria-label="<%- title %>" title="<%- title %>">
            <i class="fa-solid fa-envelope"></i>
          </a>
        <% } else if (icon == 'rss') { %>
          <a class="icon" target="_blank" rel="noopener" href="<%- link %>" aria-label="<%- title %>" title="<%- title %>">
            <i class="fa-solid fa-rss"></i>
          </a>
        <% } else { %>
          <a class="icon u-url" target="_blank" rel="noopener me" href="<%- url_for(link) %>" aria-label="<%- title %>" title="<%- title %>">
            <i class="fa-brands fa-<%= icon %>"></i>
          </a>
        <% } %>
        <%= ( nb_links > 0 && i < nb_links-1 ? ( i == nb_links-2 ? ' and ' : ', ' ) : '.' ) %>
        <% i+=1 %>
      <% } %>
    </p>
  <% } %>
</section>

<section id="writing">
  <span class="h1"><a href="<%- url_for(theme.nav.articles) %>"><%= __('index.articles') %></a></span>
  <% if (theme.tags_overview && site.tags.length) { %>
    <span class="h2"><%= __('index.topics') %></span>
    <span class="widget tagcloud">
      <%- tagcloud(theme.tags_overview) %>
    </span>
    <span class="h2"><%= __('index.most_recent') %></span>
  <% } %>
  
  <ul class="post-list">
    <% var field_sort = theme.posts_overview.sort_updated ? 'updated' : 'date' %>
    <% var show_posts = theme.posts_overview.show_all_posts 
         ? page.posts.sort(field_sort, 'desc') 
         : site.posts.sort(field_sort, 'desc').limit(theme.posts_overview.post_count || 5) %>
         
    <% show_posts.each(function(post, i){ %>
      <% var wordCount = post.content ? post.content.replace(/<[^>]+>/g,'').trim().split(/\s+/).length : 0 %>
      <% var readingMinutes = Math.max(1, Math.ceil(wordCount / 200)) %>
      <li class="post-item">
        <div class="post-title-wrapper">
          <%- partial('_partial/post/title', { post: post, index: true, class_name: '' }) %>
        </div>
        <div class="post-meta-wrapper">
          <%- partial('_partial/post/date', { post: post, class_name: 'meta' }) %>
          <span class="reading-time"><%= readingMinutes %> min read</span>
        </div>
      </li>
    <% }); %>
  </ul>

  <% if (theme.posts_overview.show_all_posts) { %>
    <%- partial('_partial/pagination') %>
  <% } %>
</section>

<% if (theme.repositories && theme.repositories.length) { %>
<section id="repositories">
  <span class="h1"><a href="<%- url_for(theme.projects_url) %>">Repositories</a></span>

  <ul class="post-list">
    <% theme.repositories.forEach(function(repo){ %>
      <li class="post-item repo-item">
        <div class="repo-content">
          <div>
            <a href="<%- repo.link %>" target="_blank" rel="noopener"><%= repo.title %></a>
            <div class="meta"><%= repo.description %></div>
          </div>
        </div>
        <div class="repo-stars" data-repo="<%- repo.link.replace('https://github.com/', '') %>">
          <i class="fa-regular fa-star"></i> <span class="star-count">-</span>
        </div>
      </li>
    <% }); %>
  </ul>

  <script>
    async function fetchStars() {
      const elements = document.querySelectorAll('.repo-stars');
      for (const el of elements) {
        const repo = el.getAttribute('data-repo');
        if (!repo) continue;
        try {
          const response = await fetch(`https://api.github.com/repos/${repo}`);
          if (!response.ok) throw new Error('API error');
          const data = await response.json();
          const count = data.stargazers_count || 0;
          el.querySelector('.star-count').textContent = count >= 1000
            ? (count / 1000).toFixed(1) + 'k'
            : count.toString();
        } catch (e) {
          console.error('Error fetching stars for ' + repo + ':', e);
          el.querySelector('.star-count').textContent = '0';
        }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fetchStars);
    } else {
      fetchStars();
    }
  </script>

  <style>
    /* Hide post wrappers that don't apply to repo items */
    .repo-item .post-title-wrapper,
    .repo-item .post-meta-wrapper {
      display: none !important;
    }

    /* Mobile & Desktop: same layout - title on top (hug), description below, stars vertically centered */
    .repo-item {
      flex-direction: row !important;
      align-items: center !important;
    }

    .repo-content {
      flex: 1;
      display: inline-block;
    }

    .repo-content > div {
      display: inline-block;
    }

    .repo-content > div a {
      display: inline;
      vertical-align: baseline;
    }

    .repo-content .meta {
      display: block;
      margin-top: 0.25rem;
      margin-right: 0;
      margin-left: 0;
      padding: 0;
      width: auto !important;
      min-width: auto !important;
      font-size: 14px;
      flex-shrink: 1;
    }

    .repo-stars {
      margin-left: 1rem;
      white-space: nowrap;
      color: var(--accent);
      flex-shrink: 0;
    }
  </style>
</section>
<% } %>

<% if (site.data.projects) { %>
<section id="projects">
  <span class="h1"><a href="<%- url_for(theme.projects_url) %>"><%= __('index.projects') %></a></span>
  <ul class="project-list">
    <% for(var obj in site.data.projects){ %>
      <li class="project-item">
        <a href="<%= site.data.projects[obj].url %>"><%= site.data.projects[obj].name %></a>: <%- markdown(site.data.projects[obj].desc) %>
      </li>
    <% } %>
  </ul>
</section>
<% } %>
